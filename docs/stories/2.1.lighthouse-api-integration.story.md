# Story 2.1: Lighthouse API Integration

## Status
Ready for Review

## Story
**As a** website evaluator,
**I want** to run Lighthouse audits programmatically,
**so that** I can score websites on performance, accessibility, best practices, and SEO

## Acceptance Criteria
1. ✓ Lighthouse CI configuration for automated audits
2. ✓ Performance score extraction (Core Web Vitals)
3. ✓ Accessibility audit results parsing
4. ✓ SEO and best practices evaluation
5. ✓ Timeout handling for slow websites (30 second limit)

## Tasks / Subtasks
- [x] Task 1: Set up Lighthouse CI configuration and dependencies (AC: 1)
  - [x] Install and configure Lighthouse CI package
  - [x] Set up environment variables for API access
  - [x] Configure audit parameters and thresholds
- [x] Task 2: Implement Lighthouse API integration service (AC: 1, 2, 3, 4)
  - [x] Create LighthouseService class extending BaseService
  - [x] Implement run_lighthouse_audit method with timeout handling
  - [x] Add error handling and retry logic with circuit breaker pattern
  - [x] Integrate with rate limiting service
- [x] Task 3: Create data models and schemas for audit results (AC: 2, 3, 4)
  - [x] Define WebsiteScore schema with performance, accessibility, SEO fields
  - [x] Create LighthouseAuditResult model for storing raw audit data
  - [x] Implement score calculation and normalization logic
- [x] Task 4: Add API endpoint for triggering Lighthouse audits (AC: 1, 2, 3, 4)
  - [x] Create POST /api/v1/website-scoring/lighthouse endpoint
  - [x] Implement request validation and response formatting
  - [x] Add proper error handling and status codes
- [x] Task 5: Implement timeout and fallback mechanisms (AC: 5)
  - [x] Add 30-second timeout configuration for audit requests
  - [x] Implement graceful degradation when audits fail
  - [x] Add logging and monitoring for timeout scenarios
- [x] Task 6: Create comprehensive unit tests (AC: 1, 2, 3, 4, 5)
  - [x] Test LighthouseService methods with mocked API responses
  - [x] Test timeout handling and error scenarios
  - [x] Test score calculation and normalization logic
  - [x] Test API endpoint with various input scenarios

## Dev Notes

### Previous Story Insights
No previous stories exist for Epic 2. This is the foundational story for the website scoring system.

### Data Models
- **WebsiteScore Schema**: Performance score (0-100), accessibility score (0-100), SEO score (0-100), best practices score (0-100), overall score (0-100)
- **LighthouseAuditResult Model**: Raw audit data storage with timestamp, run_id, business_id, and full audit JSON response
- **Score Confidence**: High/medium/low confidence levels based on audit completion status

### API Specifications
- **Endpoint**: POST /api/v1/website-scoring/lighthouse
- **Request**: JSON with business_id, website_url, and optional audit parameters
- **Response**: JSON with scores, confidence level, and audit metadata
- **Authentication**: Supabase Auth token required
- **Rate Limiting**: Integrated with existing rate limiting service

### Component Specifications
- **LighthouseService**: Backend service class extending BaseService pattern
- **Website Scoring API**: FastAPI endpoint with proper error handling and validation
- **Score Calculation**: Utility functions for normalizing and combining audit scores

### File Locations
- **Service**: `backend/src/services/lighthouse_service.py`
- **API Endpoint**: `backend/src/api/v1/website_scoring.py`
- **Schemas**: `backend/src/schemas/website_scoring.py`
- **Models**: `backend/src/models/website_scoring.py`
- **Tests**: `backend/tests/unit/test_services/test_lighthouse_service.py` and `backend/tests/unit/test_api/test_website_scoring_api.py`

### Testing Requirements
- **Test Location**: `backend/tests/unit/test_services/` and `backend/tests/unit/test_api/`
- **Test Framework**: pytest with httpx for API testing
- **Test Coverage**: Unit tests for service methods, API endpoint testing, error scenario testing
- **Mocking**: External Lighthouse API calls must be mocked for reliable testing

### Technical Constraints
- **Timeout**: 30-second maximum for Lighthouse audit completion
- **Rate Limiting**: Must integrate with existing rate limiting service
- **Error Handling**: Circuit breaker pattern for external API failures
- **Logging**: Structured logging with runId, businessId, and serviceName
- **Database**: Use repository pattern for data persistence

### External API Integration
- **Lighthouse API**: Google PageSpeed Insights API for automated website audits
- **Authentication**: API key in environment variables
- **Rate Limits**: 25,000 requests per day, 240 requests per minute
- **Endpoint**: `/runPagespeed` with URL parameter and strategy options

### Project Structure Alignment
- Follows existing backend service pattern with BaseService inheritance
- Integrates with existing API structure under `/api/v1/` namespace
- Uses established schema and model patterns for data consistency
- Follows testing strategy with unit tests in appropriate directories

## Testing
- **Test File Location**: `backend/tests/unit/test_services/test_lighthouse_service.py` and `backend/tests/unit/test_api/test_website_scoring_api.py`
- **Test Standards**: pytest framework with async support, comprehensive mocking of external APIs
- **Testing Frameworks**: pytest, httpx for API testing, pytest-asyncio for async support
- **Specific Requirements**: Test timeout scenarios, error handling, score calculation accuracy, and API endpoint validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
James - Full Stack Developer Agent (Full Stack Developer & Implementation Specialist)

### Debug Log References
*Implementation completed for Tasks 1-6 - no debug issues encountered*

### Task 5 Implementation Summary
Successfully implemented comprehensive timeout and fallback mechanisms for the Lighthouse API integration:

1. **Enhanced Timeout Configuration**: Added granular timeout settings including connect timeout (10s), read timeout (25s), and fallback timeout (15s)
2. **Fallback Mechanism**: Implemented graceful degradation with reduced-scope fallback audits when primary audits timeout
3. **Enhanced Logging**: Added comprehensive logging for timeout scenarios, fallback attempts, and fallback results
4. **Error Handling**: Enhanced error handling to properly return fallback results and handle fallback failures
5. **Testing**: Added comprehensive unit tests for both service and API levels covering all timeout and fallback scenarios

All 31 tests passing (16 service tests + 15 API tests) with no implementation issues encountered.

### Completion Notes List
- **Task 1 Completed**: Lighthouse CI configuration and dependencies setup
  - Added Lighthouse CI package configuration with lighthouserc.js
  - Updated requirements.txt with necessary Python dependencies (requests, tenacity, sqlalchemy, psycopg2-binary)
  - Created package.json for Node.js Lighthouse CI dependencies
  - Updated environment configuration with Lighthouse API settings
  - Integrated with existing rate limiting and circuit breaker infrastructure

- **Task 2 Completed**: Lighthouse API integration service implementation
  - Created LighthouseService class extending BaseService following project patterns
  - Implemented run_lighthouse_audit method with 30-second timeout handling
  - Added comprehensive error handling and retry logic using tenacity library
  - Integrated with existing rate limiting service for "lighthouse" API
  - Implemented circuit breaker pattern for external API failures
  - Added structured logging with runId, businessId, and serviceName

- **Task 3 Completed**: Data models and schemas for audit results
  - Created comprehensive Pydantic schemas for website scoring (WebsiteScore, CoreWebVitals, etc.)
  - Implemented SQLAlchemy database models with proper indexing and relationships
  - Created utility functions for score calculation and normalization
  - Added score validation, grading, and trend analysis capabilities
  - Integrated with existing project structure and import patterns

- **Task 4 Completed**: API endpoint for triggering Lighthouse audits
  - Created POST /api/v1/website-scoring/lighthouse endpoint with comprehensive validation
  - Implemented proper error handling with appropriate HTTP status codes (400, 408, 429, 500)
  - Added background task support for data persistence
  - Integrated with existing FastAPI application structure
  - Added health check and summary endpoints for monitoring

- **Task 5 Completed**: Timeout and fallback mechanisms implementation
  - Enhanced configuration with granular timeout settings (connect, read, fallback timeouts)
  - Implemented graceful degradation with fallback audit mechanism for timeout scenarios
  - Added comprehensive logging and monitoring for timeout and fallback scenarios
  - Enhanced error handling to return fallback results when primary audit fails
  - Added fallback audit with reduced scope (performance-only) for faster completion
  - Implemented proper error code handling for fallback failures

- **Task 6 Completed**: Comprehensive unit tests
  - Created LighthouseService unit tests covering all major functionality
  - Implemented API endpoint tests with mocked service responses
  - Added utility function tests for score calculation and analysis
  - Covered error scenarios, timeout handling, and validation edge cases
  - Used pytest framework with proper mocking and fixtures

### File List
**New Files Created:**
- `backend/lighthouserc.js` - Lighthouse CI configuration
- `backend/package.json` - Node.js dependencies for Lighthouse CI
- `backend/src/services/lighthouse_service.py` - Main Lighthouse API integration service
- `backend/src/schemas/website_scoring.py` - Pydantic schemas for website scoring
- `backend/src/models/website_scoring.py` - SQLAlchemy database models
- `backend/src/utils/score_calculation.py` - Score calculation utilities
- `backend/src/utils/__init__.py` - Utils package initialization
- `backend/src/models/__init__.py` - Models package initialization
- `backend/src/api/v1/website_scoring.py` - Website scoring API endpoints
- `backend/tests/unit/test_services/test_lighthouse_service.py` - Lighthouse service unit tests
- `backend/tests/unit/test_api/test_website_scoring_api.py` - Website scoring API unit tests
- `backend/tests/unit/test_utils/test_score_calculation.py` - Score calculation utility tests

**Modified Files:**
- `backend/requirements.txt` - Added Python dependencies
- `backend/env.example` - Added Lighthouse API configuration and enhanced timeout settings
- `backend/src/core/config.py` - Added Lighthouse API settings and granular timeout configurations
- `backend/src/services/rate_limiter.py` - Added Lighthouse rate limiting
- `backend/src/services/lighthouse_service.py` - Enhanced with timeout and fallback mechanisms
- `backend/src/schemas/__init__.py` - Added website scoring schema imports
- `backend/src/api/v1/__init__.py` - Added website scoring router
- `backend/src/main.py` - Added website scoring API router
- `backend/tests/unit/test_services/test_lighthouse_service.py` - Added timeout and fallback mechanism tests
- `backend/tests/unit/test_api/test_website_scoring_api.py` - Added fallback mechanism API tests

**Dependencies Added:**
- requests>=2.31.0 - HTTP client for API calls
- tenacity>=8.2.0 - Retry logic and circuit breaker
- sqlalchemy>=2.0.0 - Database ORM
- psycopg2-binary>=2.9.0 - PostgreSQL adapter
- @lhci/cli - Lighthouse CI CLI tool

## QA Results
*This section is populated by the QA agent during review*
