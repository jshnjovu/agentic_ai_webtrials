# Story 2.1: Lighthouse API Integration

## Status
Draft

## Story
**As a** website evaluator,
**I want** to run Lighthouse audits programmatically
**so that** I can score websites on performance, accessibility, best practices, and SEO

## Acceptance Criteria
1. ✓ Lighthouse CI configuration for automated audits
2. ✓ Performance score extraction (Core Web Vitals)
3. ✓ Accessibility audit results parsing
4. ✓ SEO and best practices evaluation
5. ✓ Timeout handling for slow websites (30 second limit)

## Tasks / Subtasks
- [ ] Task 1: Lighthouse CI Integration Setup (AC: 1)
  - [ ] Install and configure Lighthouse CI for programmatic audits
  - [ ] Create Lighthouse CI configuration file with audit settings
  - [ ] Set up audit categories (performance, accessibility, best-practices, SEO)
- [ ] Task 2: Performance Score Extraction (AC: 2)
  - [ ] Implement Core Web Vitals extraction (LCP, FID, CLS)
  - [ ] Parse performance metrics and scoring from Lighthouse output
  - [ ] Create performance score calculation and normalization
- [ ] Task 3: Accessibility and Best Practices Parsing (AC: 3, 4)
  - [ ] Extract accessibility audit results and violations
  - [ ] Parse best practices evaluation and recommendations
  - [ ] Implement SEO scoring from Lighthouse audit data
- [ ] Task 4: Timeout and Error Handling (AC: 5)
  - [ ] Implement 30-second timeout for Lighthouse audits
  - [ ] Add error handling for audit failures and timeouts
  - [ ] Create fallback mechanisms for failed audits

## Dev Notes

### Previous Story Insights
- Business discovery and data merging from Epic 1 stories
- API authentication and rate limiting patterns established
- Data models for business information are defined

### Data Models
- **Lighthouse Audit Request Model**: URL, device type, audit categories, timeout settings
- **Lighthouse Audit Response Model**: Performance scores, accessibility results, best practices, SEO scores
- **Core Web Vitals Model**: LCP, FID, CLS metrics with scoring and thresholds
- **Audit Summary Model**: Combined scores with confidence indicators and recommendations
[Source: architecture/data-models.md - No specific guidance found in architecture docs]

### API Specifications
- **Lighthouse CI API**: Programmatic interface for running Lighthouse audits
- **Audit Categories**: Performance, accessibility, best-practices, SEO
- **Response Format**: JSON with detailed audit results and scoring
- **Timeout Handling**: 30-second maximum for audit completion
[Source: architecture/external-apis.md - No specific guidance found in architecture docs]

### Component Specifications
- **Lighthouse Service**: Python service class extending BaseService pattern
- **Audit Runner**: Service for executing Lighthouse CI audits programmatically
- **Score Parser**: Service for extracting and normalizing audit scores
- **Timeout Manager**: Service for handling audit timeouts and fallbacks
[Source: architecture/coding-standards.md#external-api-integration]

### File Locations
- **API Routes**: `apps/api/src/api/v1/website-audit/` for audit endpoints
- **Services**: `apps/api/src/services/lighthouse_service.py` for Lighthouse integration
- **Models**: `apps/api/src/schemas/` for audit request/response models
- **Configuration**: `apps/api/src/core/lighthouse_config.py` for Lighthouse CI settings
[Source: architecture/unified-project-structure.md#api]

### Testing Requirements
- **Test Location**: `apps/api/tests/unit/test_services/test_lighthouse_service.py`
- **Test Framework**: pytest + httpx for API testing
- **Test Coverage**: Unit tests for audit execution, score parsing, and timeout handling
- **Mocking**: Lighthouse CI responses must be mocked in unit tests
- **Test Data**: Mock audit results for various website performance scenarios
[Source: architecture/testing-strategy.md#backend-tests]

### Technical Constraints
- **Python Version**: 3.11+ for backend implementation
- **FastAPI Framework**: 0.104+ for API endpoints
- **Lighthouse CI**: Latest version for programmatic audit execution
- **Timeout Handling**: 30-second maximum for audit completion
- **Error Handling**: All API routes must use standard error handler with proper HTTP status codes
- **Logging**: Use structured logging with consistent format including runId, businessId, and agentName
[Source: architecture/tech-stack.md#backend-language, architecture/coding-standards.md#error-handling]

## Testing
- **Test File Location**: `apps/api/tests/unit/test_services/test_lighthouse_service.py`
- **Test Standards**: Follow pytest patterns with proper mocking of Lighthouse CI responses
- **Testing Frameworks**: pytest + httpx for backend testing
- **Specific Requirements**: 
  - Mock Lighthouse CI audit responses for unit tests
  - Test audit execution with various website URLs and configurations
  - Validate performance score extraction and Core Web Vitals parsing
  - Test accessibility and best practices result parsing
  - Test SEO scoring and evaluation logic
  - Test timeout handling and fallback mechanisms
  - Test error handling for audit failures and edge cases

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA Agent during review*
