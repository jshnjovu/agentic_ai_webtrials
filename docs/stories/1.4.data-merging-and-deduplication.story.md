# Story 1.4: Data Merging and Deduplication

## Status
Implemented

## Story
**As a** lead generation agent,
**I want** to merge business data from multiple sources
**so that** I have complete, validated business profiles

## Acceptance Criteria
1. ✓ Business matching algorithm using name + address similarity
2. ✓ Contact information prioritization (prefer most complete data)
3. ✓ Duplicate business detection and removal
4. ✓ Data confidence scoring for merged records
5. ✓ Manual review flagging for uncertain matches

## Tasks / Subtasks
- [x] Task 1: Business Matching Algorithm Implementation (AC: 1)
  - [x] Create fuzzy string matching for business names
  - [x] Implement address similarity scoring using coordinate proximity
  - [x] Develop combined scoring algorithm (name + address weights)
- [x] Task 2: Data Merging and Prioritization (AC: 2)
  - [x] Implement contact information prioritization logic
  - [x] Create data completeness scoring for each source
  - [x] Develop merge strategy for conflicting information
- [x] Task 3: Duplicate Detection and Removal (AC: 3)
  - [x] Create duplicate detection service using business fingerprints
  - [x] Implement automatic duplicate removal for high-confidence matches
  - [x] Add duplicate flagging for manual review scenarios
- [x] Task 4: Confidence Scoring System (AC: 4)
  - [x] Implement data confidence scoring algorithm
  - [x] Create confidence level assignment (high/medium/low)
  - [x] Add confidence indicators to merged business records
- [x] Task 5: Manual Review System (AC: 5)
  - [x] Create flagging system for uncertain matches
  - [x] Implement manual review workflow for flagged records
  - [x] Add review status tracking and resolution

## Dev Notes

### Previous Story Insights
- Google Places search implementation from Story 1.2
- Yelp Fusion search implementation from Story 1.3
- API authentication and rate limiting from Story 1.1
- Both data sources provide business information that needs to be merged

### Data Models
- **Business Matching Model**: Name similarity, address proximity, combined confidence scores
- **Merged Business Model**: Combined data from both sources with confidence indicators
- **Duplicate Detection Model**: Business fingerprints and similarity thresholds
- **Review Flag Model**: Uncertain matches flagged for manual review
[Source: architecture/data-models.md - No specific guidance found in architecture docs]

### API Specifications
- **Business Matching API**: Internal service for comparing business records
- **Data Merging API**: Service for combining and prioritizing information
- **Duplicate Detection API**: Service for identifying and flagging duplicates
- **Review Management API**: Endpoints for managing manual review workflow
[Source: architecture/external-apis.md - No specific guidance found in architecture docs]

### Component Specifications
- **Matching Service**: Python service class extending BaseService pattern
- **Data Merger Service**: Service for combining business information from multiple sources
- **Duplicate Detector**: Service for identifying duplicate business records
- **Confidence Scorer**: Service for calculating data confidence levels
- **Review Manager**: Service for managing manual review workflow
[Source: architecture/coding-standards.md#external-api-integration]

### File Locations
- **API Routes**: `backend/src/api/v1/data_merging.py` for matching and merging endpoints
- **Services**: `backend/src/services/data_merging_service.py` for matching, merging, and duplicate detection services
- **Models**: `backend/src/schemas/business_merging.py` for business matching and merging models
- **Repository**: Not applicable in this iteration (no persistence layer implemented)
[Source: architecture/unified-project-structure.md#api]

### Testing Requirements
- **Test Location**: `backend/tests/unit/test_services/test_data_merging_service.py` and `backend/tests/unit/test_api/test_data_merging_api.py`
- **Test Framework**: pytest + httpx for API testing
- **Test Coverage**: Unit tests for matching algorithms, merging logic, and duplicate detection
- **Test Data**: Mock business data from both Google Places and Yelp Fusion for testing scenarios
- **Edge Cases**: Test various data quality scenarios and edge cases
[Source: architecture/testing-strategy.md#backend-tests]

### Technical Constraints
- **Python Version**: 3.11+ for backend implementation
- **FastAPI Framework**: 0.104+ for API endpoints
- **Database Access**: Always use repository pattern - never write raw SQL queries in business logic
- **Error Handling**: All API routes must use standard error handler with proper HTTP status codes
- **Logging**: Use structured logging with consistent format including runId, businessId, and agentName
- **Performance**: Implement efficient algorithms for large dataset processing
[Source: architecture/tech-stack.md#backend-language, architecture/coding-standards.md#database-access]

## Testing
- **Test File Location**: `backend/tests/unit/test_services/test_data_merging_service.py`, `backend/tests/unit/test_api/test_data_merging_api.py`
- **Test Standards**: Follow pytest patterns with comprehensive test coverage for matching algorithms
- **Testing Frameworks**: pytest + httpx for backend testing
- **Specific Requirements**: 
  - Test business name matching with various similarity scenarios
  - Test address proximity calculations and coordinate-based matching
  - Test data merging logic with conflicting information from different sources
  - Test duplicate detection with various business fingerprint scenarios
  - Test confidence scoring algorithms and threshold assignments
  - Test manual review flagging system and workflow
  - Test performance with large datasets and edge cases

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
Implemented end-to-end service, API, schemas, and tests for data merging and deduplication.

### Agent Model Used
GPT-5 (Cursor)

### Debug Log References
- Verified algorithm flow using unit tests
- Ensured router registration and health endpoint responses

### Completion Notes List
- Added `DataMergingService` with Levenshtein-based name similarity, address similarity, proximity scoring, and confidence levels
- Implemented contact prioritization (https website, E.164-like phone, longer fields)
- Added manual review flags for coordinate discrepancies and low confidence
- Created Pydantic schemas for inputs and outputs
- Added API endpoints `/api/v1/business-management/merge` and `/api/v1/business-management/merge/health`
- Wrote unit tests for service and API

### File List
- `backend/src/schemas/business_merging.py`
- `backend/src/services/data_merging_service.py`
- `backend/src/services/__init__.py`
- `backend/src/api/v1/data_merging.py`
- `backend/src/api/v1/__init__.py`
- `backend/src/main.py` (router registration)
- `backend/tests/unit/test_services/test_data_merging_service.py`
- `backend/tests/unit/test_api/test_data_merging_api.py`

## QA Results
*This section will be populated by the QA Agent during review*
