# Story 1.4: Data Merging and Deduplication

## Status
Ready for Review

## Story
**As a** lead generation agent,
**I want** to merge business data from multiple sources
**so that** I have complete, validated business profiles

## Acceptance Criteria
1. ✓ Business matching algorithm using name + address similarity
2. ✓ Contact information prioritization (prefer most complete data)
3. ✓ Duplicate business detection and removal
4. ✓ Data confidence scoring for merged records
5. ✓ Manual review flagging for uncertain matches

## Tasks / Subtasks
- [x] Task 1: Business Matching Algorithm Implementation (AC: 1)
  - [x] Create fuzzy string matching for business names
  - [x] Implement address similarity scoring using coordinate proximity
  - [x] Develop combined scoring algorithm (name + address weights)
- [x] Task 2: Data Merging and Prioritization (AC: 2)
  - [x] Implement contact information prioritization logic
  - [x] Create data completeness scoring for each source
  - [x] Develop merge strategy for conflicting information
- [x] Task 3: Duplicate Detection and Removal (AC: 3)
  - [x] Create duplicate detection service using business fingerprints
  - [x] Implement automatic duplicate removal for high-confidence matches
  - [x] Add duplicate flagging for manual review scenarios
- [x] Task 4: Confidence Scoring System (AC: 4)
  - [x] Implement data confidence scoring algorithm
  - [x] Create confidence level assignment (high/medium/low)
  - [x] Add confidence indicators to merged business records
- [x] Task 5: Manual Review System (AC: 5)
  - [x] Create flagging system for uncertain matches
  - [x] Implement manual review workflow for flagged records
  - [x] Add review status tracking and resolution

## Dev Notes

### Previous Story Insights
- Google Places search implementation from Story 1.2
- Yelp Fusion search implementation from Story 1.3
- API authentication and rate limiting from Story 1.1
- Both data sources provide business information that needs to be merged

### Data Models
- **Business Matching Model**: Name similarity, address proximity, combined confidence scores
- **Merged Business Model**: Combined data from both sources with confidence indicators
- **Duplicate Detection Model**: Business fingerprints and similarity thresholds
- **Review Flag Model**: Uncertain matches flagged for manual review
[Source: architecture/data-models.md - No specific guidance found in architecture docs]

### API Specifications
- **Business Matching API**: Internal service for comparing business records
- **Data Merging API**: Service for combining and prioritizing information
- **Duplicate Detection API**: Service for identifying and flagging duplicates
- **Review Management API**: Endpoints for managing manual review workflow
[Source: architecture/external-apis.md - No specific guidance found in architecture docs]

### Component Specifications
- **Matching Service**: Python service class extending BaseService pattern
- **Data Merger Service**: Service for combining business information from multiple sources
- **Duplicate Detector**: Service for identifying duplicate business records
- **Confidence Scorer**: Service for calculating data confidence levels
- **Review Manager**: Service for managing manual review workflow
[Source: architecture/coding-standards.md#external-api-integration]

### File Locations
- **API Routes**: `apps/api/src/api/v1/business-management/` for matching and merging endpoints
- **Services**: `apps/api/src/services/` for matching, merging, and duplicate detection services
- **Models**: `apps/api/src/schemas/` for business matching and merging models
- **Repository**: `apps/api/src/repositories/business_repository.py` for data persistence
[Source: architecture/unified-project-structure.md#api]

### Testing Requirements
- **Test Location**: `apps/api/tests/unit/test_services/test_business_matching_service.py`
- **Test Framework**: pytest + httpx for API testing
- **Test Coverage**: Unit tests for matching algorithms, merging logic, and duplicate detection
- **Test Data**: Mock business data from both Google Places and Yelp Fusion for testing scenarios
- **Edge Cases**: Test various data quality scenarios and edge cases
[Source: architecture/testing-strategy.md#backend-tests]

### Technical Constraints
- **Python Version**: 3.11+ for backend implementation
- **FastAPI Framework**: 0.104+ for API endpoints
- **Database Access**: Always use repository pattern - never write raw SQL queries in business logic
- **Error Handling**: All API routes must use standard error handler with proper HTTP status codes
- **Logging**: Use structured logging with consistent format including runId, businessId, and agentName
- **Performance**: Implement efficient algorithms for large dataset processing
[Source: architecture/tech-stack.md#backend-language, architecture/coding-standards.md#database-access]

## Testing
- **Test File Location**: `apps/api/tests/unit/test_services/test_business_matching_service.py`
- **Test Standards**: Follow pytest patterns with comprehensive test coverage for matching algorithms
- **Testing Frameworks**: pytest + httpx for backend testing
- **Specific Requirements**: 
  - Test business name matching with various similarity scenarios
  - Test address proximity calculations and coordinate-based matching
  - Test data merging logic with conflicting information from different sources
  - Test duplicate detection with various business fingerprint scenarios
  - Test confidence scoring algorithms and threshold assignments
  - Test manual review flagging system and workflow
  - Test performance with large datasets and edge cases

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
James - Full Stack Developer Agent

### Debug Log References
- Implemented Tasks 1-3 of data merging and deduplication story
- Created comprehensive schemas for business matching, merging, and duplicate detection
- Implemented three core services with full test coverage
- Fixed schema validation issues and deprecation warnings

### Completion Notes List
- **Task 1 Completed**: Business Matching Algorithm Implementation
  - Created BusinessMatchingService with fuzzy string matching using fuzzywuzzy library
  - Implemented address similarity scoring with coordinate proximity calculations
  - Developed combined scoring algorithm with configurable weights
  - Added comprehensive business name and address normalization

- **Task 2 Completed**: Data Merging and Prioritization
  - Created BusinessMergingService with data completeness scoring
  - Implemented contact information prioritization logic
  - Developed merge strategies for conflicting information
  - Added conflict resolution with confidence scoring

- **Task 3 Completed**: Duplicate Detection and Removal
  - Created DuplicateDetectionService with business fingerprinting
  - Implemented automatic duplicate removal for high-confidence matches
  - Added duplicate flagging for manual review scenarios
  - Created comprehensive fingerprinting algorithms

- **Task 4 Completed**: Confidence Scoring System
  - Implemented comprehensive data confidence scoring algorithm
  - Created confidence level assignment (high/medium/low) with proper thresholds
  - Added confidence indicators to merged business records
  - Implemented hybrid scoring for name, location, contact info, rating, categories, and hours
  - Added data quality assessment and source reliability scoring

- **Task 5 Completed**: Manual Review System
  - Created intelligent flagging system for uncertain matches using hybrid scoring
  - Implemented manual review workflow with 4-step process (initial_assessment, data_verification, conflict_resolution, final_approval)
  - Added comprehensive review status tracking and resolution workflow
  - Implemented sophisticated priority determination considering conflict count, confidence, field importance, and resolution strategy
  - Resolved catch-22 situation with hybrid approach combining conflict count and confidence factors

### File List
**New Files Created:**
- `backend/src/schemas/business_matching.py` - Business matching schemas
- `backend/src/schemas/business_merging.py` - Business merging schemas  
- `backend/src/schemas/duplicate_detection.py` - Duplicate detection schemas
- `backend/src/services/business_matching_service.py` - Business matching service
- `backend/src/services/business_merging_service.py` - Business merging service
- `backend/src/services/duplicate_detection_service.py` - Duplicate detection service
- `backend/tests/unit/test_services/test_business_matching_service.py` - Business matching tests
- `backend/tests/unit/test_services/test_business_merging_service.py` - Business merging tests
- `backend/tests/unit/test_services/test_duplicate_detection_service.py` - Duplicate detection tests

**Modified Files:**
- `backend/src/schemas/__init__.py` - Added new schema imports
- `backend/src/services/__init__.py` - Added new service imports
- `backend/requirements.txt` - Added fuzzywuzzy, python-Levenshtein, geopy dependencies
- `docs/stories/1.4.data-merging-and-deduplication.story.md` - Updated task completion status

## QA Results
*This section will be populated by the QA Agent during review*
