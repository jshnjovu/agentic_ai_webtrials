# Story 3.4: Demo Site Tracking

## Status
Draft

## Story
**As a** system operator,
**I want** to track generated demo sites,
**so that** I can manage temporary hosting and provide analytics

## Acceptance Criteria
1. ✓ Demo site URL generation and storage
2. ✓ Creation timestamp and expiration tracking
3. ✓ Basic analytics integration (page views, device types)
4. ✓ Cleanup process for expired demos
5. ✓ Performance monitoring for deployed sites

## Tasks / Subtasks
- [ ] Task 1: Create DemoSiteTrackingService class extending BaseService (AC: 1, 2, 3, 4, 5)
  - [ ] Implement demo site URL generation and storage management
  - [ ] Create timestamp tracking and expiration management system
  - [ ] Add basic analytics integration for page views and device tracking
  - [ ] Implement cleanup process for expired demo sites
  - [ ] Add performance monitoring and health checking for deployed sites
- [ ] Task 2: Implement analytics integration and monitoring (AC: 1, 2, 3, 4, 5)
  - [ ] Integrate with Vercel Analytics for page view and device tracking
  - [ ] Create custom analytics collection for business-specific metrics
  - [ ] Implement performance monitoring using Core Web Vitals
  - [ ] Add health checking and uptime monitoring for demo sites
  - [ ] Create analytics dashboard and reporting capabilities
- [ ] Task 3: Create demo site tracking data models and schemas (AC: 1, 2, 3, 4, 5)
  - [ ] Define DemoSite schema with URL, creation timestamp, expiration, and status
  - [ ] Create SiteAnalytics model for page views, device types, and performance data
  - [ ] Implement ExpirationPolicy model for cleanup rules and retention policies
  - [ ] Add PerformanceMetrics model for Core Web Vitals and health monitoring
  - [ ] Create CleanupLog model for tracking cleanup operations and results
- [ ] Task 4: Add API endpoints for demo site tracking and management (AC: 1, 2, 3, 4, 5)
  - [ ] Create POST /api/v1/demo-sites/track endpoint for new site registration
  - [ ] Implement GET /api/v1/demo-sites/{id}/analytics for analytics data
  - [ ] Add DELETE /api/v1/demo-sites/{id} for manual cleanup
  - [ ] Create GET /api/v1/demo-sites/expired for cleanup management
  - [ ] Add background task support for analytics collection and cleanup
- [ ] Task 5: Create comprehensive unit tests (AC: 1, 2, 3, 4, 5)
  - [ ] Test DemoSiteTrackingService methods with various tracking scenarios
  - [ ] Test analytics integration and data collection
  - [ ] Test API endpoints with various input scenarios
  - [ ] Test expiration management and cleanup processes
  - [ ] Test integration with existing demo site generation system

## Dev Notes

### Previous Story Insights
Stories 3.1 (Website Template Design), 3.2 (AI-Powered Content Generation), and 3.3 (Vercel Deployment Integration) established:
- Responsive HTML/CSS template foundation with mobile-first approach
- AI-generated business-specific content for personalization
- Vercel deployment integration for automated site publishing
- Template system architecture and deployment workflow
- Performance optimization and accessibility requirements

### Data Models
- **DemoSite Schema**: Site URL, creation timestamp, expiration timestamp, status (active/expired/cleanup), business_id, run_id, deployment_id
- **SiteAnalytics Model**: Page views, device types, geographic data, performance metrics, Core Web Vitals, collection timestamp
- **ExpirationPolicy Model**: Retention period, cleanup rules, notification settings, manual override options
- **PerformanceMetrics Model**: Core Web Vitals scores, load times, error rates, uptime percentage, health status
- **CleanupLog Model**: Cleanup timestamp, sites removed, cleanup reason, manual vs automatic, cleanup status

### API Specifications
- **Endpoints**: 
  - POST /api/v1/demo-sites/track (new site registration)
  - GET /api/v1/demo-sites/{id}/analytics (analytics data)
  - DELETE /api/v1/demo-sites/{id} (manual cleanup)
  - GET /api/v1/demo-sites/expired (cleanup management)
- **Request/Response**: JSON with appropriate data structures for each endpoint
- **Authentication**: Supabase Auth token required
- **Rate Limiting**: Integrated with existing rate limiting service for "demo-sites" API

### Component Specifications
- **DemoSiteTrackingService**: Backend service class extending BaseService pattern
- **Demo Site Tracking API**: FastAPI endpoints with proper error handling and validation
- **Analytics Integration**: Vercel Analytics and custom metrics collection
- **Performance Monitoring**: Core Web Vitals and health checking
- **Cleanup System**: Automated and manual cleanup processes

### File Locations
- **Service**: `backend/src/services/demo_site_tracking_service.py`
- **API Endpoint**: `backend/src/api/v1/demo_sites.py`
- **Schemas**: `backend/src/schemas/demo_sites.py`
- **Models**: `backend/src/models/demo_sites.py`
- **Tests**: `backend/tests/unit/test_services/test_demo_site_tracking_service.py` and API tests

### Testing Requirements
- **Test Location**: `backend/tests/unit/test_services/` and API tests
- **Test Framework**: pytest with httpx for API testing
- **Test Coverage**: Unit tests for service methods, API endpoint testing, analytics integration testing
- **Mocking**: Analytics API calls must be mocked for reliable testing

### Technical Constraints
- **Performance**: Analytics collection must not impact demo site performance
- **Rate Limiting**: Must integrate with existing rate limiting service
- **Error Handling**: Graceful degradation when analytics or monitoring fail
- **Logging**: Structured logging with runId, businessId, and serviceName
- **Database**: Use existing repository pattern for data persistence

### Analytics Requirements
- **Page View Tracking**: Visitor count and page view analytics
- **Device Analytics**: Device types, browsers, and screen resolutions
- **Performance Monitoring**: Core Web Vitals and load time tracking
- **Geographic Data**: Visitor location and regional performance
- **Custom Metrics**: Business-specific tracking and conversion data

### Project Structure Alignment
- Follows existing backend service pattern with BaseService inheritance
- Integrates with existing API structure under `/api/v1/` namespace
- Uses established schema and model patterns for data consistency
- Follows testing strategy with unit tests in appropriate directories
- Integrates with Epic 3 template, content generation, and deployment for complete demo site lifecycle

## Testing
- **Test File Location**: `backend/tests/unit/test_services/test_demo_site_tracking_service.py` and API tests
- **Test Standards**: pytest framework with async support, comprehensive analytics integration testing
- **Testing Frameworks**: pytest, httpx for API testing, pytest-asyncio for async support
- **Specific Requirements**: Test tracking accuracy, analytics collection, cleanup processes, and API endpoint validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
*To be populated during implementation*

### Debug Log References
*To be populated during implementation*

### Implementation Summary
*To be populated during implementation*

### Completion Notes List
*To be populated during implementation*

### File List
*To be populated during implementation*

## QA Results
*This section is populated by the QA agent during review*
