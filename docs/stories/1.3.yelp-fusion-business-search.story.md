# Story 1.3: Yelp Fusion Business Search

## Status
Draft

## Story
**As a** lead generation agent,  
**I want** to search Yelp Fusion as a secondary source
**so that** I can validate and enrich business information

## Acceptance Criteria
1. ✓ Business search with location and category parameters
2. ✓ Business details extraction including reviews and hours
3. ✓ Photo and additional contact information retrieval
4. ✓ Category mapping between Google and Yelp taxonomies
5. ✓ Rate limiting compliance (5000 requests per day)

## Tasks / Subtasks
- [ ] Task 1: Yelp Fusion API Integration Service (AC: 1, 2)
  - [ ] Create Yelp Fusion API client service
  - [ ] Implement business search with location and category parameters
  - [ ] Extract business details including reviews and operating hours
- [ ] Task 2: Enhanced Data Extraction (AC: 3)
  - [ ] Implement photo retrieval from Yelp API
  - [ ] Extract additional contact information beyond basic details
  - [ ] Handle missing data gracefully with fallback values
- [ ] Task 3: Category Taxonomy Mapping (AC: 4)
  - [ ] Create mapping between Google Places and Yelp category systems
  - [ ] Implement category translation for consistent search results
  - [ ] Handle category mismatches and edge cases
- [ ] Task 4: Rate Limiting and Compliance (AC: 5)
  - [ ] Implement daily request counting and limiting
  - [ ] Add rate limiting middleware specific to Yelp Fusion
  - [ ] Create rate limit monitoring and alerting

## Dev Notes

### Previous Story Insights
- API authentication and rate limiting configuration from Story 1.1
- Google Places search implementation patterns from Story 1.2
- Environment variables for Yelp Fusion API key are already configured
- Rate limiting middleware and circuit breaker pattern are in place

### Data Models
- **Yelp Business Search Request Model**: Location, category, limit, offset parameters
- **Yelp Business Data Model**: Name, address, phone, website, rating, reviews, hours, photos
- **Category Mapping Model**: Google Places to Yelp category translation table
- **Enhanced Business Model**: Combined data from both sources with confidence scoring
[Source: architecture/data-models.md - No specific guidance found in architecture docs]

### API Specifications
- **Yelp Fusion Business Search API**: `/v3/businesses/search` endpoint
- **Authentication**: Bearer token via Authorization header (from Story 1.1)
- **Rate Limiting**: 5000 requests per day limit (configured in Story 1.1)
- **Response Format**: JSON with business details, reviews, photos, and hours
[Source: architecture/external-apis.md - No specific guidance found in architecture docs]

### Component Specifications
- **Search Service**: Python service class extending BaseService pattern
- **API Client**: Centralized API client with proper error handling and retry logic
- **Category Mapper**: Service for translating between Google and Yelp taxonomies
- **Data Enrichment**: Service for combining and validating data from multiple sources
[Source: architecture/coding-standards.md#external-api-integration]

### File Locations
- **API Routes**: `apps/api/src/api/v1/business-search/` for search endpoints
- **Services**: `apps/api/src/services/yelp_fusion_service.py` for Yelp Fusion integration
- **Category Mapping**: `apps/api/src/services/category_mapper_service.py` for taxonomy translation
- **Models**: `apps/api/src/schemas/` for Yelp-specific request/response models
[Source: architecture/unified-project-structure.md#api]

### Testing Requirements
- **Test Location**: `apps/api/tests/unit/test_services/test_yelp_fusion_service.py`
- **Test Framework**: pytest + httpx for API testing
- **Test Coverage**: Unit tests for search service, category mapping, and data enrichment
- **Mocking**: Yelp Fusion API responses must be mocked in unit tests
- **Test Data**: Mock business search responses with various data scenarios including photos and hours
[Source: architecture/testing-strategy.md#backend-tests]

### Technical Constraints
- **Python Version**: 3.11+ for backend implementation
- **FastAPI Framework**: 0.104+ for API endpoints
- **External API Integration**: Must include circuit breaker pattern and exponential backoff retry logic
- **Rate Limiting**: Strict compliance with Yelp's 5000 requests per day limit
- **Error Handling**: All API routes must use standard error handler with proper HTTP status codes
- **Logging**: Use structured logging with consistent format including runId, businessId, and agentName
[Source: architecture/tech-stack.md#backend-language, architecture/coding-standards.md#external-api-integration]

## Testing
- **Test File Location**: `apps/api/tests/unit/test_services/test_yelp_fusion_service.py`
- **Test Standards**: Follow pytest patterns with proper mocking of Yelp Fusion API responses
- **Testing Frameworks**: pytest + httpx for backend testing
- **Specific Requirements**: 
  - Mock Yelp Fusion API responses for unit tests
  - Test search functionality with various location and category combinations
  - Validate data extraction for all business fields including photos and hours
  - Test category mapping between Google Places and Yelp taxonomies
  - Test rate limiting compliance and daily request counting
  - Test error handling for API failures and rate limit exceeded scenarios
  - Test data enrichment and combination logic

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA Agent during review*
